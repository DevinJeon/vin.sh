" setting for encoding
set encoding=utf-8
set fileencoding=utf-8
set fileencodings=ucs-bom,utf-8,cp949,latin1

syntax on " Enable highlighting syntax

set nocp " not compatible with `vi`
set hls " hightlight search keywords
set ruler " show current cursor location
set history=1000 " history of vim command
set expandtab " softtab(space)
set tabstop=4 " tab size
set sw=4 " tab size: shifting(`<<`, `>>`)
set sts=4 " tab size: shifting(`<<`, `>>`)
set autoindent
set backspace=indent,eol,start

hi Search ctermbg=4 ctermfg=15
hi Visual ctermbg=White ctermfg=Black

" Custom shortcut
nnoremap <C-p> :set paste<CR>i
nnoremap <C-o> :set nopaste<CR>
nnoremap <C-j> <C-w>j
nnoremap <C-k> <C-w>k
nnoremap <C-h> <C-w>h
nnoremap <C-l> <C-w>l
nnoremap <C-q> :q<CR>

" ==============================
" Plugins
call plug#begin('~/.vim/plugged')

" For Git
Plug 'rhysd/committia.vim'
Plug 'hotwatermorning/auto-git-diff'

" NERDTree=<Leader>n
Plug 'scrooloose/nerdtree', { 'on': 'NERDTreeToggle' }

" Asyncsearch=<Leader>ff
Plug 'eugen0329/vim-esearch'

" Command-T=<Leader>t
Plug 'wincent/command-t', {
    \   'do': 'cd ruby/command-t/ext/command-t && ruby extconf.rb && make'}

" Multiple cursors=<C-n>
Plug 'terryma/vim-multiple-cursors'

" Graph undo tree
Plug 'simnalamburt/vim-mundo'

" Show indent
Plug 'Yggdroot/indentLine'

" airline
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'

" For Python
Plug 'fisadev/vim-isort'

" For Golang
Plug 'fatih/vim-go', { 'do': ':GoUpdateBinaries' }

" google/vimcodefmt
Plug 'google/vim-maktaba'
Plug 'google/vim-glaive'
Plug 'google/vim-codefmt'

" LSP
Plug 'prabirshrestha/vim-lsp'
Plug 'mattn/vim-lsp-settings'
Plug 'prabirshrestha/asyncomplete.vim'
Plug 'prabirshrestha/asyncomplete-lsp.vim'

" Other
Plug 'tpope/vim-commentary' " Add shortcut `gc[c]` to comment out
Plug 'sheerun/vim-polyglot' " Highlight many languages syntax
Plug 'dense-analysis/ale' " Asynchronous Lint Engine

call plug#end()
" ==============================

" google/vimcodefmt
autocmd FileType c,cpp,proto let b:codefmt_formatter='clang-format'
autocmd FileType vue,javascript,html,css,sass,scss,less,json let b:codefmt_formatter='prettier'
autocmd FileType python let b:codefmt_formatter='yapf'
autocmd FileType go let b:codefmt_formatter='gofmt'
autocmd FileType bash,sh,zsh let b:codefmt_formatter='shfmt'

" Python isort
autocmd FileType python let g:vim_isort_map = '<C-i>'
autocmd FileType python map <C-i> :Isort<CR>
autocmd FileType python let g:vim_isort_python_version = 'python3'

" NERDTree
nnoremap <Leader>n :NERDTreeToggle<CR>

" LSP
inoremap <expr> <Tab>   pumvisible() ? "\<C-n>" : "\<Tab>"
inoremap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"
inoremap <expr> <cr>    pumvisible() ? "\<C-y>" : "\<cr>"
noremap <C-e>ca :LspCodeAction<CR>
noremap <C-e>cl :LspCodeLens<CR>
noremap gdd :LspDefinition<CR>
noremap gdt :tab LspDefinition<CR>
noremap gdv :rightbelow vertical LspDefinition<CR>
noremap gdh :rightbelow LspDefinition<CR>
noremap <C-e>gd :LspDefinition<CR>
noremap <C-e>da :tab split<CR>:LspDocumentDiagnostics<CR>
noremap <C-e>ss :LspDocumentSymbol<CR>
noremap <C-e>h :LspHover<CR>
noremap <C-e>nd :LspNextDiagnostic<CR>
noremap <C-e>ne :LspNextError<CR>
noremap <C-e>nr :LspNextReference<CR>
noremap <C-e>nw :LspNextWarning<CR>
noremap <C-e>pe :LspPreviousError<CR>
noremap <C-e>pr :LspPreviousReference<CR>
noremap <C-e>pw :LspPreviousWarning<CR>
noremap <C-e>rf :vs<CR>:LspReferences<CR>
noremap <F6> :LspRename<CR>
noremap <C-e>rn :LspRename<CR>
" let g:lsp_highlight_references_enabled = 1
" hi lspReference ctermfg=Black ctermbg=226

" Code format
vmap <C-e>f :FormatLines<CR>:LspDocumentRangeFormat<CR>
nmap <C-e>f :FormatCode<CR>:LspDocumentFormat<CR>
" Code format + isort(python)
autocmd FileType python vmap <C-e>f <C-i>:FormatLines<CR>:LspDocumentRangeFormat<CR>
autocmd FileType python nmap <C-e>f :Isort<CR>:FormatCode<CR>:LspDocumentFormat<CR>

" ale
" Use mypy only if it's available on the current virtualenv
let g:ale_python_mypy_executable = 'python -m mypy'

" python line length
augroup filetype_python
  autocmd!
  " highlight characters past column 80
  autocmd FileType python hi Excess ctermbg=Red ctermfg=White guibg=Red
  autocmd FileType python match Excess /\%81v.*/
  autocmd FileType python set nowrap
  autocmd FileType python hi ColorColumn ctermbg=240 ctermfg=White
  autocmd FileType python set colorcolumn=80
  autocmd FileType python set expandtab
augroup END

" indentLine
let g:indentLine_char = 'â”†'
let g:indentLine_color_term = 243
let g:indentLine_color_gui = '#767676'

" Airline theme
let g:airline_theme='bubblegum'

" Mundo
nnoremap <F5> :MundoToggle<CR>
